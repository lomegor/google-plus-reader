<script src="scripts/jquery.js"></script>
<script type="text/javascript">
var ok=false;
function checkOk() {
  if(!ok) {
    setTimeout
  } else {
  }
}
function postUrlGetOk(url,tab) {
  if (!ok) {
    console.log("sended");
    chrome.tabs.sendRequest(tab.id, {href:url}, function() {
      ok=true;
    });
    setTimeout(function(){postUrlGetOk(url,tab)},1000);
  } else {
    ok=false;
  }
}

chrome.extension.onRequest.addListener(
  function (request,sender,sendResponse) {
    if (request.reader) {
      chrome.tabs.getSelected(null, function(tab) {
        postUrlGetOk(request.href,tab);
      });
    } else if (request.method=="GET") {
      $.ajax({
        url:request.url,
        dataType:request.dataType,
        success:function(data) {
          if (request.dataType=="xml") {
            data = xml2json(data); 
          }
          sendResponse(data);
        },
        error:function(jqXHR,text,error) {
          console.log(jqXHR);
        }
        });
    }
  }
);
/**
 * Convert XML to JSON Object
 * @param {Object} XML DOM Document
 */
function xml2json(xml) {
 var obj = {};
 
 if (xml.nodeType == 1) { // element
  // do attributes
  if (xml.attributes.length > 0) {
   obj['@attributes'] = {};
   for (var j = 0; j < xml.attributes.length; j++) {
    obj['@attributes'][xml.attributes[j].nodeName] = xml.attributes[j].nodeValue;
   }
  }
  
 } else if (xml.nodeType == 3) { // text
  obj = xml.nodeValue;
 }
 
 // do children
 if (xml.hasChildNodes()) {
  for(var i = 0; i < xml.childNodes.length; i++) {
   if (typeof(obj[xml.childNodes[i].nodeName]) == 'undefined') {
    obj[xml.childNodes[i].nodeName] = xml2json(xml.childNodes[i]);
   } else {
    if (typeof(obj[xml.childNodes[i].nodeName].length) == 'undefined') {
     var old = obj[xml.childNodes[i].nodeName];
     obj[xml.childNodes[i].nodeName] = [];
     obj[xml.childNodes[i].nodeName].push(old);
    }
    obj[xml.childNodes[i].nodeName].push(xml2json(xml.childNodes[i]));
   }
   
  }
 }

 return obj;
};
</script>
